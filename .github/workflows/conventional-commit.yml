name: Conventional Commit Check

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Debug from email
        run: echo "FROM_EMAIL=$FROM_EMAIL"
      - name: Check PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close PR if failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              state: "closed"
            })

      # SendGrid: SENDGRID_FROM_EMAIL must be the EXACT verified address (e.g. noreply@yourdomain.com).
      # Use only the email, no "Name <email>" unless that identity is verified. No leading/trailing spaces.
      - name: Email on failure
        if: failure()
        run: |
          curl -X POST https://api.sendgrid.com/v3/mail/send \
          -H "Authorization: Bearer $SENDGRID_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "personalizations":[{"to":[{"email":"'"$ALERT_EMAIL_TO"'"}]}],
            "from":{"email":"'"$ALERT_EMAIL_FROM"'"},
            "subject":"PR Closed - Bad Commit Message",
            "content":[{"type":"text/plain","value":"Your PR was closed because it did not follow Conventional Commit format."}]
          }'
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          ALERT_EMAIL_TO: ${{ secrets.ALERT_EMAIL_TO }}
          ALERT_EMAIL_FROM: ${{ secrets.ALERT_EMAIL_FROM }}